<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr.BAMH Blood Storage Centre Antisera Inventory</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #343a40;
            line-height: 1.4;
            padding: 15px;
            min-height: 100vh;
            font-size: 13px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #2c5aa0;
        }
        .app-header h1 {
            color: #2c5aa0;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: #2c5aa0;
            color: white;
        }
        .btn-primary:hover {
            background: #1e4a8a;
            transform: translateY(-1px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #343a40;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #138496;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-dark {
            background: #343a40;
            color: white;
        }
        .btn-dark:hover {
            background: #1d2124;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
        }
        .inventory-table th {
            background: #2c5aa0;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }
        .inventory-table td {
            padding: 6px;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
        }
        .group-row {
            background: #e9ecef;
            font-weight: 700;
        }
        .lot-row:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            color: white;
            display: inline-block;
        }
        .status-badge.good {
            background: #28a745;
        }
        .status-badge.expiring-soon {
            background: #ffc107;
            color: #343a40;
        }
        .status-badge.expired {
            background: #dc3545;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .modal {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        #usageLogModal .modal {
            max-width: 1200px; /* Wider modal for log table */
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #343a40;
            font-size: 13px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        #logFilterForm {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        #logFilterForm .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .log-table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .log-table th, .log-table td {
            padding: 8px;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        .log-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .no-print {}
        @media print {
            @page {
                size: portrait;
                margin: 0.5cm;
            }
            body {
                background: white !important;
                padding: 0 !important;
                font-size: 10px !important;
            }
            .no-print {
                display: none !important;
            }
            .container {
                max-width: none !important;
                margin: 0 !important;
            }
            .inventory-table {
                font-size: 9px !important;
                width: 100% !important;
            }
            .inventory-table th,
            .inventory-table td {
                padding: 3px 5px !important;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header no-print">
        <div class="app-header-left">
            <h1><i class="fas fa-vial-circle-check"></i> Dr.BAMH Blood Storage Centre Antisera Inventory</h1>
        </div>
        <div class="app-header-right" style="display: flex; gap: 8px;">
            <button class="btn btn-primary" onclick="showAddForm()"><i class="fas fa-plus"></i> Add Lot</button>
            <button class="btn btn-info" onclick="showUsageLogModal()"><i class="fas fa-history"></i> Usage Log</button>
            <button class="btn btn-secondary" onclick="printReport()"><i class="fas fa-print"></i> Print</button>
            <button class="btn btn-warning" onclick="exportData()" title="This only exports the currently loaded data. The master data is safe in Firebase."><i class="fas fa-download"></i> Export Backup</button>
            <button class="btn btn-dark" onclick="importData()" title="Not recommended. Data is live from Firebase."><i class="fas fa-upload"></i> Import Backup</button>
            <button class="btn btn-danger" onclick="clearAllData()"><i class="fas fa-trash-alt"></i> Clear All</button>
        </div>
    </div>
    
    <table class="inventory-table" aria-label="Antisera Inventory">
        <thead>
            <tr>
                <th>Antisera</th>
                <th>Lot</th>
                <th>Manufacturer</th>
                <th>Expiry</th>
                <th>Vol.</th>
                <th>Remain</th>
                <th>Status</th>
                <th class="no-print">Actions</th>
            </tr>
        </thead>
        <tbody id="inventoryTableBody"></tbody>
    </table>

    <div id="emptyState" class="message no-print" style="text-align:center; margin-top: 20px; display:none;">
        <i class="fas fa-inbox" style="font-size: 36px; color: #6c757d; margin-bottom: 10px;"></i>
        <h3>No Inventory Found</h3>
        <p>Add your first lot to get started!</p>
        <button class="btn btn-primary" onclick="showAddForm()"><i class="fas fa-plus"></i> Add First Lot</button>
    </div>

    <div id="addLotModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
        <div class="modal">
            <h2 id="modalTitle"><i class="fas fa-plus-circle"></i> Add New Antisera Lot</h2>
            <form id="addLotForm" onsubmit="handleAddOrEditLot(event)">
                <input type="hidden" id="editLotId" />
                <div class="form-group">
                    <label for="antiseraName">Antisera Type</label>
                    <select id="antiseraName" required>
                        <option value="Anti A">Anti A</option>
                        <option value="Anti B">Anti B</option>
                        <option value="Anti AB">Anti AB</option>
                        <option value="Anti D">Anti D</option>
                        <option value="Anti A1">Anti A1</option>
                        <option value="Anti H">Anti H</option>
                        <option value="AHG">AHG</option>
                        <option value="Papain">Papain</option>
                        <option value="Bov. Albumin">Bov. Albumin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lotNumber">Lot Number</label>
                    <input type="text" id="lotNumber" placeholder="Enter lot number" required />
                </div>
                <div class="form-group">
                    <label for="manufacturer">Manufacturer</label>
                    <input type="text" id="manufacturer" placeholder="Enter manufacturer" />
                </div>
                <div class="form-group">
                    <label for="dateReceived">Date Received</label>
                    <input type="date" id="dateReceived" />
                </div>
                <div class="form-group">
                    <label for="issueDate">Issue Date (First opened)</label>
                    <input type="date" id="issueDate" />
                </div>
                <div class="form-group">
                    <label for="expiryDate">Expiry Date (Month & Year)</label>
                    <input type="month" id="expiryDate" required />
                </div>
                <div class="form-group">
                    <label for="volumeMl">Volume per Vial</label>
                    <select id="volumeMl">
                        <option value="5">5 ml</option>
                        <option value="10" selected>10 ml</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="totalVials">Total Vials in Lot</label>
                    <input type="number" id="totalVials" min="1" value="1" required />
                </div>
                <div class="form-group">
                    <label for="remarks">Remarks</label>
                    <textarea id="remarks" placeholder="Additional notes or remarks"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddForm()"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="useVialModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="useModalTitle" tabindex="-1">
        <div class="modal">
            <h2 id="useModalTitle"><i class="fas fa-minus-circle"></i> Use Antisera Vial(s)</h2>
            <form id="useVialForm" onsubmit="handleUseVial(event)">
                <input type="hidden" id="useLotId" required />
                <p>Antisera: <strong id="useAntiseraName"></strong> (Lot: <strong id="useLotNumber"></strong>)</p>
                <div class="form-group">
                    <label for="vialsToUse">Number of Vials to Use (Max: <span id="maxVials"></span>)</label>
                    <input type="number" id="vialsToUse" min="1" value="1" required />
                </div>
                <div class="form-group">
                    <label for="usedBy">Used By</label>
                    <input type="text" id="usedBy" placeholder="Technician Name" required />
                </div>
                <div class="form-group">
                    <label for="usageReason">Reason for Usage</label>
                    <textarea id="usageReason" placeholder="e.g., Routine Grouping, QC, T&S"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Confirm Usage</button>
                    <button type="button" class="btn btn-secondary" onclick="hideUseModal()"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="usageLogModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="logModalTitle" tabindex="-1">
        <div class="modal">
            <h2 id="logModalTitle"><i class="fas fa-history"></i> Antisera Usage Log</h2>
            <form id="logFilterForm" onchange="filterUsageLog()" onsubmit="event.preventDefault()">
                <div class="form-group">
                    <label for="logFilterStart">Start Date</label>
                    <input type="date" id="logFilterStart" onchange="filterUsageLog()" />
                </div>
                <div class="form-group">
                    <label for="logFilterEnd">End Date</label>
                    <input type="date" id="logFilterEnd" onchange="filterUsageLog()" />
                </div>
                <div class="form-group">
                    <label for="logFilterAntisera">Antisera</label>
                    <select id="logFilterAntisera" onchange="filterUsageLog()">
                        <option value="">All Types</option>
                        <option value="Anti A">Anti A</option>
                        <option value="Anti B">Anti B</option>
                        <option value="Anti AB">Anti AB</option>
                        <option value="Anti D">Anti D</option>
                        <option value="Anti A1">Anti A1</option>
                        <option value="Anti H">Anti H</option>
                        <option value="AHG">AHG</option>
                        <option value="Papain">Papain</option>
                        <option value="Bov. Albumin">Bov. Albumin</option>
                    </select>
                </div>
                <button type="button" class="btn btn-info" onclick="printLogReport()"><i class="fas fa-print"></i> Print Log</button>
            </form>
            
            <div class="log-table-container">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Antisera</th>
                            <th>Lot Used</th>
                            <th>Vials</th>
                            <th>Used By</th>
                            <th>Reason</th>
                            <th>Lot Expiry</th>
                        </tr>
                    </thead>
                    <tbody id="usageLogTableBody">
                        </tbody>
                </table>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hideUsageLogModal()"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
    // --- STEP 1: PASTE YOUR FIREBASE CONFIG HERE ---
    // (Get this from Step 1 of my instructions)
    const firebaseConfig = {
      apiKey: "AIzaSyD3eAtKPGtcaZ66lFnm6yiNyUmHPjDXQfI",
      authDomain: "antisera-inventory.firebaseapp.com",
      projectId: "antisera-inventory",
      storageBucket: "antisera-inventory.firebasestorage.app",
      messagingSenderId: "476018143035",
      appId: "1:476018143035:web:8a406f16d17602bbfe911e",
      measurementId: "G-5DGJQ124QR"
     };
    // --- END OF CONFIG ---

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const inventoryCollection = db.collection("inventory");
    const usageLogCollection = db.collection("usageLog");


    // --- Global App State ---
    let inventory = [];
    let usageLog = [];
    const fixedOrder = ["Anti A", "Anti B", "Anti AB", "Anti D", "Anti A1", "Anti H", "AHG", "Papain", "Bov. Albumin"];
    
    // We still use localStorage for *user-specific* preferences
    const LAST_USED_BY_KEY = "lastUsedBy";
    const DEFAULT_TECHNICIAN = 'SAJITH';
    const DEFAULT_REASON = 'DAILY USE';

    // --- App Initialization ---
    document.addEventListener("DOMContentLoaded", init);

    async function init() {
        console.log("Connecting to Firebase...");
        await loadData();
        renderInventory();
        console.log("Data loaded and rendered.");
    }

    // --- Data Persistence (NOW USES FIREBASE) ---

    async function loadData() {
        try {
            // Load Inventory
            const inventorySnapshot = await inventoryCollection.get();
            inventory = inventorySnapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    ...data,
                    id: doc.id,
                    // Convert Firebase Timestamps back to JS Date objects
                    expiryDate: data.expiryDate ? data.expiryDate.toDate() : null,
                    dateReceived: data.dateReceived ? data.dateReceived.toDate() : null,
                    issueDate: data.issueDate ? data.issueDate.toDate() : null,
                };
            });

            // Load Usage Log
            const usageLogSnapshot = await usageLogCollection.get();
            usageLog = usageLogSnapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    ...data,
                    id: doc.id,
                    usedDate: data.usedDate ? data.usedDate.toDate() : null,
                    lotExpiry: data.lotExpiry ? data.lotExpiry.toDate() : null,
                };
            });
            console.log("Firebase data loaded.");
        } catch (err) {
            console.error("Error loading data from Firebase: ", err);
            alert("Error loading data from database. Check console for details.");
        }
    }

    // saveData() is no longer needed. We save directly in each function.

    // --- Utility Functions (Unchanged) ---

    function generateId() {
        // We'll use Firestore's automatic IDs, but this can be a fallback
        // or used for things that aren't in the DB.
        // For simplicity, we'll let Firestore generate IDs for *new* items.
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Expiry format "JAN 2026"
    function formatExpiryMonth(date) {
        if (!date) return "N/A";
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const d = new Date(date);
        const year = d.getFullYear();
        return months[d.getMonth()] + " " + year;
    }
    
    // Date/Time format "DD/MM/YYYY HH:mm"
    function formatDateTime(date) {
        if (!date) return "N/A";
        const d = new Date(date);
        const pad = (num) => num.toString().padStart(2, '0');
        const dateStr = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
        const timeStr = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
        return `${dateStr} ${timeStr}`;
    }

    function getExpiryStatus(expiryDate) {
        if (!expiryDate) return "good";
        const today = new Date();
        const expiry = new Date(expiryDate);
        expiry.setMonth(expiry.getMonth() + 1);
        expiry.setDate(0); 
        const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        if (diffDays <= 0) return "expired";
        if (diffDays <= 30) return "expiring-soon";
        return "good";
    }
    
    // --- Inventory Rendering (Unchanged) ---

    function renderInventory() {
        const tbody = document.getElementById("inventoryTableBody");
        const emptyState = document.getElementById("emptyState");
        const activeLots = inventory.filter(item => item.remainingVials > 0);
        
        if (activeLots.length === 0) {
            tbody.innerHTML = "";
            emptyState.style.display = "block";
            return;
        }
        emptyState.style.display = "none";

        const grouped = {};
        activeLots.forEach(item => {
            if (!grouped[item.antiseraName]) grouped[item.antiseraName] = [];
            grouped[item.antiseraName].push(item);
        });
        
        Object.keys(grouped).forEach(key => {
            grouped[key].sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
        });
        
        const sortedAntisera = fixedOrder.filter(type => grouped[type]);

        let html = "";
        sortedAntisera.forEach(antiseraName => {
            const lots = grouped[antiseraName];
            const totalVials = lots.reduce((sum, lot) => sum + lot.remainingVials, 0);
            
            html += `
            <tr class="group-row">
                <td colspan="4"><strong>${antiseraName}</strong></td>
                <td></td>
                <td><strong>${totalVials}</strong></td>
                <td colspan="2"><strong>Total vial${totalVials !== 1 ? "s" : ""} available</strong></td>
            </tr>`;
            
            lots.forEach(item => {
                const status = getExpiryStatus(item.expiryDate);
                html += `
                <tr class="lot-row" data-id="${item.id}">
                    <td>${item.antiseraName}</td>
                    <td>${item.lotNumber}</td>
                    <td>${item.manufacturer || "NA"}</td>
                    <td><strong>${formatExpiryMonth(item.expiryDate)}</strong></td>
                    <td>${item.volumeMl} ml</td>
                    <td><strong>${item.remainingVials}</strong></td>
                    <td><span class="status-badge ${status}">${status.replace("-", " ").toUpperCase()}</span></td>
                    <td class="no-print">
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="editLot(event, '${item.id}')" title="Edit Lot"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-success btn-sm" onclick="showUseModal(event, '${item.id}')" title="Use Vial(s)"><i class="fas fa-minus"></i> Use</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteLot(event, '${item.id}')" title="Delete Lot"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
        });
        tbody.innerHTML = html;
    }

    // --- Add/Edit/Delete Logic (MODIFIED FOR FIREBASE) ---

    function showAddForm(lot = null) {
        document.getElementById("addLotModal").style.display = "flex";
        const title = document.getElementById("modalTitle");
        const form = document.getElementById("addLotForm");
        form.reset();
        document.getElementById("editLotId").value = "";

        if (lot) {
            title.innerHTML = '<i class="fas fa-edit"></i> Edit Antisera Lot';
            document.getElementById("editLotId").value = lot.id;
            document.getElementById("antiseraName").value = lot.antiseraName;
            document.getElementById("lotNumber").value = lot.lotNumber;
            document.getElementById("manufacturer").value = lot.manufacturer !== "NA" ? lot.manufacturer : "";
            document.getElementById("dateReceived").value = lot.dateReceived ? lot.dateReceived.toISOString().split("T")[0] : "";
            document.getElementById("issueDate").value = lot.issueDate ? lot.issueDate.toISOString().split("T")[0] : "";
            
            if (lot.expiryDate) {
                let year = lot.expiryDate.getFullYear();
                let month = lot.expiryDate.getMonth() + 1;
                if (month < 10) month = "0" + month;
                document.getElementById("expiryDate").value = `${year}-${month}`;
            } else {
                document.getElementById("expiryDate").value = "";
            }
            document.getElementById("volumeMl").value = lot.volumeMl;
            document.getElementById("totalVials").value = lot.totalVials;
            document.getElementById("remarks").value = lot.remarks;
        } else {
            title.innerHTML = '<i class="fas fa-plus-circle"></i> Add New Antisera Lot';
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            document.getElementById("expiryDate").value = nextYear.toISOString().substring(0, 7);
            document.getElementById("dateReceived").value = new Date().toISOString().split("T")[0];
        }
    }

    function hideAddForm() {
        document.getElementById("addLotModal").style.display = "none";
    }

    async function handleAddOrEditLot(event) {
        event.preventDefault();
        const idField = document.getElementById("editLotId");
        const isEditing = idField.value !== "";

        const expiryMonthYear = document.getElementById("expiryDate").value;
        const expiryDate = new Date(expiryMonthYear + "-01");
        expiryDate.setMonth(expiryDate.getMonth() + 1);
        expiryDate.setDate(0); 

        const formData = {
            antiseraName: document.getElementById("antiseraName").value,
            lotNumber: document.getElementById("lotNumber").value.trim(),
            manufacturer: document.getElementById("manufacturer").value.trim() || "NA",
            dateReceived: document.getElementById("dateReceived").value ? new Date(document.getElementById("dateReceived").value) : null,
            issueDate: document.getElementById("issueDate").value ? new Date(document.getElementById("issueDate").value) : null,
            expiryDate: expiryDate,
            volumeMl: parseInt(document.getElementById("volumeMl").value),
            totalVials: parseInt(document.getElementById("totalVials").value),
            remainingVials: parseInt(document.getElementById("totalVials").value), // Default for new, will be recalculated for edit
            remarks: document.getElementById("remarks").value.trim() || ""
        };

        try {
            if (isEditing) {
                const lotId = idField.value;
                const oldLot = inventory.find(lot => lot.id === lotId);
                const usedCount = oldLot.totalVials - oldLot.remainingVials;
                formData.remainingVials = Math.max(0, formData.totalVials - usedCount);
                
                // --- FIREBASE: Update existing document ---
                await inventoryCollection.doc(lotId).set(formData, { merge: true }); // merge: true is safer, like an update
                
                // Update local cache
                const idx = inventory.findIndex(lot => lot.id === lotId);
                inventory[idx] = { ...formData, id: lotId };
                alert("Lot updated successfully!");

            } else {
                // --- FIREBASE: Add new document ---
                const docRef = await inventoryCollection.add(formData);
                
                // Add to local cache
                inventory.push({ ...formData, id: docRef.id });
                alert("Lot added successfully!");
            }
            renderInventory();
            hideAddForm();
        } catch (err) {
            console.error("Error saving lot: ", err);
            alert("Error saving lot: " + err.message);
        }
    }

    function editLot(event, lotId) {
        event.stopPropagation();
        const lot = inventory.find(l => l.id === lotId);
        if (!lot) return alert("Lot not found!");
        showAddForm(lot);
    }

    async function deleteLot(event, lotId) {
        event.stopPropagation();
        if (confirm("Are you sure you want to delete this lot from the database? This action cannot be undone.")) {
            try {
                // --- FIREBASE: Delete document ---
                await inventoryCollection.doc(lotId).delete();
                
                // Update local cache
                inventory = inventory.filter(lot => lot.id !== lotId);
                renderInventory();
                alert("Lot deleted successfully!");
            } catch (err) {
                console.error("Error deleting lot: ", err);
                alert("Error deleting lot: " + err.message);
            }
        }
    }

    // --- Use Vial Modal Logic (MODIFIED FOR FIREBASE) ---

    function showUseModal(event, lotId) {
        event.stopPropagation();
        const item = inventory.find(i => i.id === lotId);
        if (!item) return alert("Lot not found!");

        document.getElementById("useLotId").value = lotId;
        document.getElementById("useAntiseraName").textContent = item.antiseraName;
        document.getElementById("useLotNumber").textContent = item.lotNumber;
        document.getElementById("maxVials").textContent = item.remainingVials;
        document.getElementById("vialsToUse").value = 1;
        document.getElementById("vialsToUse").max = item.remainingVials;
        
        const lastUsedBy = localStorage.getItem(LAST_USED_BY_KEY);
        document.getElementById("usedBy").value = lastUsedBy || DEFAULT_TECHNICIAN; 
        document.getElementById("usageReason").value = DEFAULT_REASON; 
        
        document.getElementById("useVialModal").style.display = "flex";
    }

    function hideUseModal() {
        document.getElementById("useVialModal").style.display = "none";
        document.getElementById("useVialForm").reset();
    }

    async function handleUseVial(event) {
        event.preventDefault();
        const lotId = document.getElementById("useLotId").value;
        const quantity = parseInt(document.getElementById("vialsToUse").value);
        const usedBy = document.getElementById("usedBy").value.trim();
        const reason = document.getElementById("usageReason").value.trim();
        
        const item = inventory.find(i => i.id === lotId);
        
        if (!item) {
            alert("Lot not found!");
            return;
        }
        if (!usedBy) {
            alert("Please enter your name.");
            return;
        }
        if (quantity <= 0 || quantity > item.remainingVials) {
            alert(`Invalid quantity. You can only use between 1 and ${item.remainingVials} vials.`);
            return;
        }

        const newRemaining = item.remainingVials - quantity;
        const logEntry = {
            lotId: lotId,
            lotNumber: item.lotNumber,
            antiseraName: item.antiseraName,
            vialsUsed: quantity,
            usedBy: usedBy,
            reason: reason,
            usedDate: new Date(), // Use server timestamp? No, client's date is fine.
            lotExpiry: item.expiryDate 
        };

        try {
            // --- FIREBASE: Use a transaction to ensure safety ---
            // A transaction ensures BOTH operations (update inventory AND add log)
            // succeed or fail together. This prevents data corruption.
            await db.runTransaction(async (transaction) => {
                const lotDocRef = inventoryCollection.doc(lotId);
                const logDocRef = usageLogCollection.doc(); // Create ref for new log

                // 1. Update the inventory item
                transaction.update(lotDocRef, { remainingVials: newRemaining });
                
                // 2. Create the new usage log entry
                transaction.set(logDocRef, logEntry);
            });

            // --- Update local cache ---
            item.remainingVials = newRemaining;
            usageLog.push({ ...logEntry, id: "temp-id" }); // Add to local log
            
            localStorage.setItem(LAST_USED_BY_KEY, usedBy); 
            renderInventory();
            hideUseModal();
            alert(`${quantity} vial${quantity > 1 ? "s" : ""} of ${item.antiseraName} used successfully!`);

        } catch (err) {
            console.error("Error processing usage: ", err);
            alert("Error saving usage: " + err.message);
        }
    }

    // --- Usage Log Modal & Reporting (Unchanged logic, just uses global 'usageLog') ---

    function showUsageLogModal() {
        document.getElementById("usageLogModal").style.display = "flex";
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById("logFilterStart").value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById("logFilterEnd").value = today.toISOString().split('T')[0];
        
        filterUsageLog();
    }
    
    function hideUsageLogModal() {
        document.getElementById("usageLogModal").style.display = "none";
    }
    
    function filterUsageLog() {
        const startDateStr = document.getElementById("logFilterStart").value;
        const endDateStr = document.getElementById("logFilterEnd").value;
        const antiseraFilter = document.getElementById("logFilterAntisera").value;
        
        let filteredLog = [...usageLog]; 
        
        if (startDateStr) {
            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0); 
            filteredLog = filteredLog.filter(log => log.usedDate >= startDate);
        }
        
        if (endDateStr) {
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999); 
            filteredLog = filteredLog.filter(log => log.usedDate <= endDate);
        }
        
        if (antiseraFilter) {
            filteredLog = filteredLog.filter(log => log.antiseraName === antiseraFilter);
        }
        
        filteredLog.sort((a, b) => b.usedDate - a.usedDate);
        
        renderUsageLogTable(filteredLog);
    }

    function renderUsageLogTable(logs) {
        const tbody = document.getElementById("usageLogTableBody");
        let html = "";
        
        if (logs.length === 0) {
            html = '<tr><td colspan="7" style="text-align:center;">No usage entries found for the selected filter.</td></tr>';
        } else {
            logs.forEach(log => {
                html += `
                <tr>
                    <td>${formatDateTime(log.usedDate)}</td>
                    <td>${log.antiseraName}</td>
                    <td>${log.lotNumber}</td>
                    <td>${log.vialsUsed}</td>
                    <td>${log.usedBy}</td>
                    <td>${log.reason}</td>
                    <td>${log.lotExpiry ? formatExpiryMonth(log.lotExpiry) : 'N/A'}</td>
                </tr>
                `;
            });
        }
        tbody.innerHTML = html;
    }

    function printLogReport() {
        const logModal = document.getElementById('usageLogModal').querySelector('.modal');
        const printContent = logModal.outerHTML;

        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Usage Log Report</title>');
        printWindow.document.write('<style>');
        printWindow.document.write('body { font-family: sans-serif; padding: 20px; }');
        printWindow.document.write('.log-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10px;}');
        printWindow.document.write('.log-table th, .log-table td { border: 1px solid #ccc; padding: 5px; text-align: left; }');
        printWindow.document.write('h2 { color: #2c5aa0; }');
        printWindow.document.write('#logFilterForm, .form-actions, .btn { display: none; }'); 
        printWindow.document.write('</style></head><body>');
        printWindow.document.write(printContent);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }


    // --- Backup and System Functions (MODIFIED) ---

    // Note: Export/Import are less critical now, as data is live in the cloud.
    // They now only export/import the *locally loaded* data.

    function exportData() {
        const data = {
            inventory: inventory,
            usageLog: usageLog,
            exportDate: new Date().toISOString(),
            version: "4.0-firebase"
        };
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(dataBlob);
        link.download = `blood-bank-local-export-${new Date().toISOString().split("T")[0]}.json`;
        link.click();
        alert("Local data exported successfully! The master copy is safe in Firebase.");
    }

    function importData() {
        alert("Import is disabled in Firebase mode to prevent overwriting cloud data.");
        // We *could* build a function to batch-upload a JSON,
        // but it's dangerous. Disabling is safer.
    }

    function printReport() {
        window.print();
    }

    async function clearAllData() {
        if (!confirm("WARNING: This will delete ALL data from the CLOUD DATABASE permanently! Are you absolutely sure?")) return;
        if (!confirm("This cannot be undone. This will delete the data for ALL users. Please confirm again.")) return;
        
        try {
            // Delete all inventory items
            const invSnapshot = await inventoryCollection.get();
            for (const doc of invSnapshot.docs) {
                await inventoryCollection.doc(doc.id).delete();
            }
            
            // Delete all log items
            const logSnapshot = await usageLogCollection.get();
            for (const doc of logSnapshot.docs) {
                await usageLogCollection.doc(doc.id).delete();
            }

            // Clear local cache
            inventory = [];
            usageLog = [];
            renderInventory();
            alert("All cloud data cleared successfully!");
        } catch (err) {
            console.error("Error clearing all data: ", err);
            alert("Error clearing data: " + err.message);
        }
    }
</script>

</body>
</html>